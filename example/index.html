<html>
  <head>
    <title>Dialog System</title>
    <link href="font/retro.ttf" rel="stylesheet" />
  </head>
  <style>
    body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      overflow: hidden;
      font-family: 'Retro Gaming', sans-serif;
    }
  </style>
  <body>
    <button onclick="popupControl.onAction()">Action</button>
    <button onclick="popupControl.onUp()">Up</button>
    <button onclick="popupControl.onDown()">Down</button>
    <button id="start-over" onclick="startDialog()">Start over</button>
    <div id="root"></div>
    </body>
  <script type="module">
    import { attachPopup, MenuItemBehavior } from './dist/index.js';
    const { ui, popupControl, detach } = attachPopup(document.getElementById("root"));
    window.popupControl = popupControl;
    window.MenuItemBehavior = MenuItemBehavior;
    window.detach = detach;

    async function openTestDialog() {
      return await ui.openDialog({
          position: [50, 200],
          positionFromBottom: true,
          conversation: {
            messages: [
              { text: "Hello there." },
              {
                text: "How are you?",
                action: ui => ui.openMenu({
                  position: [400, 360],
                  size: [undefined, 150],
                  positionFromBottom: true,
                  positionFromRight: true,
                  maxRows: 3,
                  items: [
                    {
                      label: "I don't know",
                      behavior: MenuItemBehavior.NONE,
                      action: [
                        ui => ui.openDialog({
                          position: [100, 100],
                          size: [300, 200],
                          conversation: {
                            messages: [
                              { text: "You should know!" },
                            ],
                          },
                        }),
                      ],
                    },
                    {
                      label: "good",
                      action: ui => ui.addConversation({
                        messages: [
                          { text: "That's nice to know!" },
                        ],
                      }),
                    },
                    {
                      label: "bad",
                      action: [
                        ui => ui.openDialog({
                          position: [100, 100],
                          size: [300, 200],
                          conversation: {
                            messages: [
                              { text: "Get better!" },
                            ],
                          },
                        }),
                      ],
                    },
                    {
                      label: "----",
                      disabled: true,
                    },
                    {
                      label: "bye",
                    },
                  ],
                }),
              },
              { text: "Good bye!" },
            ]
          },
        });      
    }


    window.startDialog = () => {
      document.getElementById('start-over').disabled = true;
      setTimeout(async () => {
        await ui.openMenu({
          items: [
            { label: "Test", action: openTestDialog, behavior: MenuItemBehavior.HIDE_ON_SELECT },
            { label: "Exit" },
          ],
        });


        document.getElementById('start-over').disabled = false;
      }, 100);
    };
    window.startDialog();
  </script>
  <script>
    let isKeyDown = false;
    document.addEventListener("keyup", e => {
      isKeyDown = false;
    });
    document.addEventListener("keydown", e => {
      if (isKeyDown) {
        return;
      }
      isKeyDown = true;
      switch(e.code) {
        case "KeyS":
        case "ArrowDown":
          popupControl.onDown();
          break;
        case "KeyW":
        case "ArrowUp":
          popupControl.onUp();
          break;
        case "Space":
          if (document.getElementById("start-over").disabled) {
            popupControl.onAction();
          } else {
            startDialog();            
          }
          break;
      }
    });
  </script>
</html>
